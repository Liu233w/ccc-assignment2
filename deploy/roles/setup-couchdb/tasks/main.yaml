---

- name: Set an alias of host ip
  set_fact:
    host_ip: '{{hostvars[inventory_hostname].ansible_default_ipv4.address}}'

- name: 'Setup CouchDB environment variable'
  lineinfile:
    path: /etc/environment
    regexp: '{{ item.reg }}'
    line: '{{ item.text }}'
  loop:
  - reg: '^COUCH_DB_USER='
    text: 'COUCH_DB_USER={{couchdb.user}}'
  - reg: '^COUCH_DB_PASS='
    text: 'COUCH_DB_PASS={{couchdb.pwd}}'
  - reg: '^COUCH_DB_SECRET='
    text: 'COUCH_DB_SECRET={{couchdb.secret}}'
  - reg: '^COUCH_DB_VERSION='
    text: 'COUCH_DB_VERSION={{couchdb.version}}'
  - reg: '^HOST_IP='
    text: 'HOST_IP={{hostvars[inventory_hostname].ansible_default_ipv4.address}}'

- name: Create CouchDB container
  docker_container:
    name: couchdb
    image: ibmcom/couchdb3:{{couchdb.version}}
    state: present
    recreate: yes
    env:
      COUCHDB_USER: '{{couchdb.user}}'
      COUCHDB_PASSWORD: '{{couchdb.pwd}}'
      COUCHDB_SECRET: '{{couchdb.secret}}'
      ERL_FLAGS: '-setcookie {{couchdb.secret}} -name couchdb@{{host_ip}}'
    exposed_ports:
    - '5984'
    volumes:
    - /home/couchdb/data:/mnt/data/couchdb

- name: 'Setup systemd file'
  copy:
    src: couchdb.service
    dest: /etc/systemd/system/couchdb.service
    mode: u=rw,g=r,o=r

- name: Start couchdb
  systemd:
    name: couchdb
    state: started
    daemon_reload: true
    enabled: true